# 08. 통합점: 게이트웨이, 터널, 릴레이

HTTP는 웹에 있는 모든 리소스에 대한 프로토콜로 사용된다.
여러 종류의 리소스에 접근하고 다른 프로토콜이나 애플리케이션 간 통신에 HTTP가 어떻게 쓰이는지 알아보자.

## 게이트웨이

하나의 어플리케이션으로 복잡한 리소스 모두를 처리하기 힘들어지면서 리소스를 받기 위한 경로를 안내하기 위한 목적으로 고안되었으며 HTTP 트래픽을 다른 프로토콜로 변환하여 HTTP 클라이언트가 다른 프로토콜을 알 필요 없이 서버에 접속할 수 있게 한다.

- FTP URL을 가리키는 `HTTP 요청`을 받아 HTTP로 변환하여 `FTP 서버`에 전달한다.
- 암호화된 웹 요청을 `SSL`으로 받고 인증서를 이용해 요청을 복호화하고 `HTTP` 요청을 서버에 전달한다.
- `서버 게이트웨어 API`를 통해 HTTP 요청을 `애플리케이션`에 전달한다.

### 클라이언트 측 게이트웨이와 서버 측 게이트웨이

웹 게이트웨이는 한쪽에서는 HTTP로 반대쪽에서는 다른 프로토콜로 통신하는데 `<클라이언트 프로토콜>/<서버 프로토콜>` 형식으로 표현한다.

- 서버 측 게이트웨이는 클라이언트와 HTTP로 통신하고 서버와는 다른 프로토콜로 통신한다.
- 클라이언트 측 게이트웨이는 클라이언트와는 다른 프로토콜로 통신하고 서버와 HTTP로 통신한다.

## 프로토콜 게이트웨이

브라우저에 게이트웨이를 설정하거나 게이트웨이를 리버스 프록시로 설정하면 HTTP 요청을 게이트웨이로 보낼 수 있다. 이 경우 일반적인 HTTP 트래픽에는 영향을 주지 않으며 설정된 프로토콜 요청만 게이트웨이에서 처리하게 된다.

### HTTP/\*: 서버 측 웹 게이트웨이

서버 측 웹 게이트웨이는 클라이언트로부터 HTTP 요청이 서버 영역으로 들어오는 시점에 클라이언트 측의 HTTP 요청을 외래 프로토콜로 전환한다.

그림에서는 HTTP를 통해 요청했을시 `HTTP/FTP` 인바운드 변환 게이트웨이에서 FTP서버에게 인증과 요청 정보를 전달하여 해당 데이터를 반환하고, 해당 객체를 받는대로 HTTP응답에 실어서 클라이언트에게 전송한다.

### HTTP/HTTPS: 서버 측 보안 게이트웨이

`HTTP/HTTPS` 게이트웨이를 사용하면 모든 웹 요청을 암호화 하여 전달하여 개인 정보 보호와 보안을 제공할 수 있다.

### HTTPS/HTTP: 클라이언트 측 보안 가속 게이트웨이

웹 서버의 앞단에서 동작하여 보안 가속기 역할을 하는 `HTTPS/HTTP` 게이트웨이가 있다. 해당 게이트웨이는 보이지 않는 `인터셉트 게이트웨이`나 `리버스 프락시` 역할을 하며 효율적으로 보안 트래픽을 복호화 하는 암호화 하드웨어를 내장해서 성능을 높이기도 한다.

게이트웨이와 원 서버간에는 암호화 하지 않은 트래픽을 전송하기 때문에 그 사이의 네트워크가 안전한지 확인 하고 사용 해야 한다.

## 리소스 게이트웨이

게이트웨이의 가장 일반적인 형태인 애플리케이션 서버는 목적지 서버와 게이트웨이를 한개의 서버로 결합한다. 애플리케이션 서버는 HTTP를 통해서 클라이언트와 통신하고 서버 측에 있는 애플리케이션 프로그램에 연결하는 서버 측 게이트웨이다.

어플리케이션 서버는 게이트웨이의 `API`를 통해서 요청을 다른 어플리케이션에 전달하고 결과를 받아서 클라이언트에 전송한다.

서버 게이트웨이 어플리케이션은 URL의 `query string`에 따라 게이트웨이 프로세스를 생성하고 해당되는 응답을 반환한다.

### 공용 게이트웨이 인터페이스

최초의 서버 확장이자 가장 널리 쓰이는 서버 확장으로 웹에서 동적인 HTML, 신용카드처리, 데이터베이스 질의 등을 제공한다.

`CGI` 애플리케이션이 서버와 분리되면서 `펄`, `Tcl`, `C`, `셸` 등 다양한 언어로 구현이 가능하다.

단순하기 때문에 거의 모든 HTTP 서버가 지원하며 성능관련 비용이 발생, 부하가 크고 서버의 성능을 제어, 장비에 부담을 준다. 이 부분을 보완하기 위해 `FastCGI`가 나왔다.

### 서버 확장 API

서버 자체의 동작을 바꾸거나 서버의 처리 능력을 최고치로 끌어올리기 위해 개발된 확장 API로 서버의 동작을 변경 할 수 있게 한다.

FrontPage Server Extensions (FPSE)는 서버 확장 API의 한 예로 FPSE를 사용하면 웹 서버에 다양한 기능을 추가할 수 있으며 폼 처리, 데이터베이스 연동, 동적 콘텐츠 생성 등의 기능을 제공할 수 있다.

## 애플리케이션 인터페이스와 웹 서비스

`웹 서비스`는 서로 다른 플랫폼과 애플리케이션이 통신할 수 있는 방법을 제공한다. 애플리케이션 인터페이스는 자동화된 웹 클라이언트가 서버와 통신하도록 설계된다.

## 터널

`터널`은 HTTP 통신을 지원하지 않는 어플리케이션과 HTTP 통신을 할 수 있게 한다. 예를 들어 HTTPS 통신을 지원하지 않는 프록시 서버가 HTTPS 통신을 지원하는 서버와 통신하려면 HTTPS 터널을 사용할 수 있다.

### CONNECT로 HTTP 터널 커넥션 맺기

HTTP 클라이언트가 HTTPS 터널을 사용하려면 `CONNECT` 메서드를 사용해야 한다. 클라이언트는 `CONNECT` 메서드를 사용해서 HTTPS 터널을 연결하고, 터널을 통해 데이터를 보낼 수 있다.

CONNECT 요청

```
CONNECT www.example.com:443 HTTP/1.1
Host: www.example.com
User-agent: Mozilla/5.0
```

CONNECT 응답

```
HTTP/1.1 200 Connection established
Proxy-agent: ProxyAgent/1.0
```

CONNECT 메서드는 프록시 서버와 HTTPS 연결을 맺고, 클라이언트와 서버 사이에 보안적으로 안전한 터널을 만들어 통신 내용을 외부에서 엿볼 수 없게 한다.

### 데이터 터널링, 시간, 커넥션 관리

터널을 통해 전달되는 데이터는 게이트웨이에서 볼수 없으며 터널링 된 프로토콜은 데이터 의존성을 포함하고 있거나 터널의 한쪽에서 입력받은 데이터를 무시할 수 있으므로 다른 끝단에서 데이터를 소비하지 않으면 교착 상태가 일어날 수 있다.

터널의 커넥션이 끊어지면 끊어진 곳에서 온 데이터는 반대편으로 전달되지만 그 커넥션도 프락시에 의해 끊어질것이고 아직 전송하지 않은 데이터는 버려진다.

- IPsec (GPRS 터널링 프로토콜): IPv6를 IPv4 위에서 실행하는 것과 같이 특정 프로토콜을 지원하지 않는 네트워크 위에서 외부 프로토콜을 실행할 수 있도록 합니다.
- SSH (Secure Socket 터널링 프로토콜): TCP/IP 연결을 맺고 암호화된 데이터를 전송할 수 있도록 합니다.
- PPTP (Point-to-Point 터널링 프로토콜): 특정 프로토콜을 지원하지 않는 네트워크 위에서 외부 프로토콜을 실행할 수 있도록 합니다.
- 기타 다른 터널링 프로토콜에는 DNS, MQTT, SMS 등이 있습니다.

### SSL 터널링

웹 터널은 원래 방화벽을 통해서 암호화된 SSL 트래픽을 전달하려고 개발되었으나 더 강력한 보안을 위해 모든 트래픽이 라우터와 프락시를 지나도록 하였다.

SSL 터널링은 HTTP 프락시가 HTTPS 터널을 지원할 수 있게 해준다. 웹 브라우저와 웹 서버 사이의 SSL 연결을 프락시가 열어둔다. 이때 프락시는 클라이언트와 서버 사이에서 SSL 연결을 열고 클라이언트와 서버 사이에서 암호화된 SSL 데이터를 전달한다.

터널은 HTTP가 아닌 트래픽이 포트를 제한하는 방화벽을 통과할 수 있게 해주지만 악의적인 트래픽이 사내로 유입되는 통로가 될 수 있다.

### SSL 터널링 vs HTTP/HTTPS 게이트웨이

HTTPS 프로토콜은 원격 HTTPS 서버와 SSL 세션을 시작하는 게이트웨리를 두고 클라이언트 측의 HTTPS 트랜젝션을 수행하는데 프락시가 복호화 된 데이터를 HTTP를 통해 클라이언트를 전송하는 방식으로 몇가지 단점이 있다.

- 클라이언트-게이트웨이 사이에 보안적으로 취약한 데이터가 노출된다.
- 프락시가 인증을 담당하므로 원격 서버에서 SSL 인증을 할 수 없다.
- 게이트웨이가 SSL을 완벽히 지원해야 한다.

이 경우 SSL 터널링을 사용하면 프락시에 SSL을 구현할 필요가 없이 암호화된 데이터를 그대로 터널리하여 전송 할 수 있다.

### 터널 인증

HTTP의 다른 기능들을 터널과 함께 사용할 수 있으며 터널은 인증이 필요한 프록시를 통해 사용될 수 있다.

클라이언트에서 CONNECT 요청을 게이트웨이로 전송하면 게이트웨이는 인증을 위해 클라이언트에게 407 응답을 전송한다.

```txt
CONNECT www.example.com:443 HTTP/1.1
Host: www.example.com
User-agent: Mozilla/5.0

HTTP/1.1 407 Proxy Authentication Required
Proxy-Authenticate: Basic realm="proxy"
```

클라이언트는 인증 헤더를 포함한 CONNECT 요청을 재전송하고 TCP 커넥션을 맺은 후 커넥션 준비 메시지를 응답한다.

```txt
CONNECT www.example.com:443 HTTP/1.1
Host: www.example.com
User-agent: Mozilla/5.0
Proxy-authorization: Basic dXNlcjpwYXNz

HTTP/1.1 200 Connection established
```

### 터널 보안에 대한 고려 사항들

터널 게이트웨이는 터널을 올바른 용도로 사용하고 있는지 검증할 수 없으므로 오용을 최소화 하기 위해 HTTPS 포트인 443과 같이 특정 포트만을 지원하도록 설정하는 것이 좋다.

## 릴레이

릴레이는 간단한 프록시로 바이트를 맹목적으로 전달하며 단순한 방식으로 구현하기 쉽다. 다만 Connection 헤더를 제대로 처리하지 못해 keep-alive 커넥션이 hang에 걸리는 문제가 있다(멍청한 프록시).
